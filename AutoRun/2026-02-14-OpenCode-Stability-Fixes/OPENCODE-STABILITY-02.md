# Phase 02: Fix Test/Typing Regressions and Config Consistency

- [x] Fix TypeScript errors introduced in `container/agent-runner/src/__tests__/` by correcting import paths, exported type references, and unsafe private-field casts. Prefer test helpers over direct mutation of private adapter internals. Success criteria: `cd container/agent-runner && npm run build` passes without test-related TS errors.
  - Completed 2026-02-14: removed private-field mutation patterns in OpenCode adapter tests via setup helpers, fixed backend mock typing/implicit-any issues, corrected test import extension mismatch, and replaced invalid `ContainerOutput` type import with a local test contract. Verified with `cd container/agent-runner && npx tsc -p tsconfig.json --noEmit && npm run build`.

- [x] Standardize OpenCode model env precedence across host/container codepaths: keep `NANOCLAW_OPENCODE_MODEL` as canonical, support `NANOCLAW_MODEL` as backward-compatible fallback, and apply one deterministic precedence order in `src/container-runner.ts`, `container/agent-runner/src/sdk-adapter/opencode-adapter.ts`, and related config handling. Success criteria: unit tests verify precedence and resulting model selection.
  - Completed 2026-02-14: added shared host resolver (`src/opencode-model.ts`) and wired deterministic precedence (`NANOCLAW_OPENCODE_MODEL` > `NANOCLAW_MODEL` > default) through `src/config.ts`, `src/container-runner.ts`, and `src/backend-health.ts`; aligned container adapter resolution in `container/agent-runner/src/sdk-adapter/opencode-adapter.ts` with the same order and blank-value handling; updated docs in `docs/SDK-BACKENDS.md`; and added/updated tests in `src/opencode-model.test.ts`, `src/config.test.ts`, `src/container-runner.test.ts`, and `container/agent-runner/src/__tests__/sdk-adapter.test.ts`. Verified with `npm test -- src/opencode-model.test.ts src/config.test.ts src/container-runner.test.ts`, `npm run build`, `cd container/agent-runner && npx tsc -p tsconfig.json --noEmit && npm run build`.

- [x] Stabilize host test execution for the failing suites (`src/db.test.ts`, `src/ipc-auth.test.ts`, `src/opencode-ipc.test.ts`) by addressing worker/pool instability via test configuration and/or suite isolation changes. Success criteria: all three suites pass reliably in at least two consecutive runs with documented command(s).
  - Completed 2026-02-14: diagnosed worker failures as native `better-sqlite3` crashes inside Vitest fork workers, rebuilt `better-sqlite3` (`npm rebuild better-sqlite3`), and hardened host Vitest config in `vitest.config.ts` with deterministic fork execution (`maxWorkers: 1`, `fileParallelism: false`). Also added explicit DB test teardown support (`_closeTestDatabase`) and wired `afterAll` cleanup in DB-backed suites (`src/db.test.ts`, `src/ipc-auth.test.ts`, `src/opencode-ipc.test.ts`, `src/routing.test.ts`) to avoid handle leaks between tests.
  - Verified with two consecutive runs:
    - `npm test -- src/db.test.ts src/ipc-auth.test.ts src/opencode-ipc.test.ts`
    - `npm test -- src/db.test.ts src/ipc-auth.test.ts src/opencode-ipc.test.ts`
